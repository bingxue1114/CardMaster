<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardMaster 2026 æ——è‰¦ç‰ˆ</title>
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’³</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .best-card { transform: scale(1.02); border-color: #f59e0b; box-shadow: 0 20px 25px -5px rgba(245, 158, 11, 0.2); }
        .sync-loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(30px); }
    </style>
</head>
<body class="max-w-md mx-auto shadow-2xl min-h-screen bg-slate-50">

<div id="app" class="min-h-screen pb-24">
    <header class="p-6 bg-slate-900 text-white rounded-b-[2.5rem] shadow-xl mb-6 sticky top-0 z-40">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-amber-400 tracking-tight">CardMaster</h1>
                <p class="text-[10px] opacity-50 font-bold tracking-widest uppercase">2026 å®Œæ•´æ¬Šç›ŠåŒæ­¥ç‰ˆ v2.1</p>
            </div>
            <div class="flex gap-2">
                <div @click="showSettings = true" class="cursor-pointer bg-white/10 p-2 rounded-full border border-white/20 text-amber-200"><i class="fas fa-cog"></i></div>
                <div @click="syncFromCloud" class="cursor-pointer bg-white/10 px-3 py-1 rounded-full border border-white/20 text-[10px] font-bold text-amber-200 flex items-center">
                    <i :class="['fas fa-sync-alt mr-1', isSyncing ? 'sync-loading' : '']"></i>
                    {{ isSyncing ? 'åŒæ­¥ä¸­' : 'é€£ç·šé›²ç«¯' }}
                </div>
            </div>
        </div>
    </header>

    <div v-if="toast.show" class="fixed top-10 left-1/2 -translate-x-1/2 z-[200] px-6 py-3 rounded-2xl shadow-2xl font-black text-sm transition-all"
        :class="toast.type === 'success' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'">
        {{ toast.msg }}
    </div>

    <div class="px-5 space-y-6">
        <div class="space-y-3">
            <div class="relative bg-white rounded-3xl p-4 shadow-sm border-2 border-transparent focus-within:border-amber-400 transition-all">
                <div class="flex items-center">
                    <i class="fas fa-search text-slate-300 mr-2"></i>
                    <input v-model="skInput" @focus="showSuggestions = true" type="text" placeholder="è¼¸å…¥åº—åæˆ–æ”¯ä»˜æ–¹å¼..." class="w-full bg-transparent focus:outline-none font-bold text-slate-700">
                    <i v-if="skInput" @click="skInput = ''" class="fas fa-times-circle text-slate-300 cursor-pointer"></i>
                </div>
                <div v-if="suggestions.length > 0 && showSuggestions" class="absolute left-0 top-full z-50 w-full bg-white border rounded-2xl mt-2 shadow-2xl overflow-hidden font-bold max-h-60 overflow-y-auto">
                    <div v-for="s in suggestions" :key="s.name" @click="selectsk(s)" class="p-4 hover:bg-amber-50 cursor-pointer border-b last:border-0 flex justify-between items-center">
                        <span class="text-slate-700">{{ s.name }}</span>
                        <span class="text-[10px] bg-slate-100 px-2 py-1 rounded-full text-slate-400">{{ s.category }}</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <div class="flex-1 bg-white rounded-3xl p-4 shadow-sm flex items-center">
                    <span class="text-amber-500 font-black mr-2 text-xl">$</span>
                    <input v-model.number="amount" type="number" class="w-full bg-transparent focus:outline-none font-mono text-xl font-bold">
                </div>
                <div class="bg-white px-4 rounded-3xl shadow-sm flex flex-col justify-center min-w-[100px]">
                    <p class="text-[9px] font-black text-slate-400 uppercase">UNI ä»»å‹™</p>
                    <div class="flex items-center gap-2">
                        <input v-model.number="uniCount" type="range" min="1" max="5" class="w-16 h-1.5 accent-orange-500">
                        <span class="font-mono font-bold text-orange-600 text-sm">{{ uniCount }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-5">
            <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] ml-2">æ™ºèƒ½æ¨è–¦æ’è¡Œ</h2>
            <div v-for="(res, index) in sortedResults" :key="res.id" 
                class="bg-white p-6 rounded-[2.5rem] border-2 relative transition-all duration-300 shadow-sm"
                :class="[index === 0 ? 'best-card border-amber-400' : 'border-transparent opacity-95']">
                
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center">
                        <div :class="['w-12 h-12 rounded-2xl flex items-center justify-center mr-3 text-white shadow-sm text-xl', res.iconColor]">
                            <i :class="res.icon"></i>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase leading-none mb-1">{{ res.bank }}</p>
                            <h3 class="text-lg font-black text-slate-800">{{ res.name }}</h3>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-black text-slate-800 tracking-tighter">{{ res.rate }}<span class="text-sm ml-0.5">%</span></div>
                        <div class="flex gap-1 mt-1 justify-end">
                            <button @click="openDetails(res)" class="text-[10px] font-bold bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full hover:bg-slate-200">è©³æƒ…</button>
                            <button @click="openUpdate(res)" class="text-[10px] font-bold bg-slate-900 text-amber-400 px-3 py-1.5 rounded-full">æ›´æ–°</button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-50 flex justify-between items-center">
                    <div>
                        <span class="text-blue-600 text-[11px] font-black block mb-0.5">{{ res.plan }}</span>
                        <p class="text-[11px] text-slate-400 font-medium">{{ res.note }}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xl font-black text-slate-800 font-mono">{{ calculateReward(amount, res.rate, res.rounding) }}</span>
                        <p class="text-[9px] font-bold text-slate-400 uppercase">{{ res.pointType }}</p>
                    </div>
                </div>

				<div v-if="res.rateDetails && res.rateDetails.length > 0" class="mt-4 space-y-3">
					<div v-for="(act, idx) in res.rateDetails" :key="idx" class="bg-slate-50 p-3 rounded-2xl border border-slate-100">
						<div class="flex justify-between items-end mb-1.5">
							<div>
								<p class="text-[9px] font-black text-slate-400 uppercase tracking-wider">
									{{ act.name }} 
									<span class="ml-1 font-bold" :class="act.isFull ? 'text-red-500' : 'text-slate-600'">
										{{ act.activeRate }}%
									</span>
								</p>
								<p class="text-[10px] font-mono font-bold text-slate-700">
									å·²åˆ· ${{ (getCardStorage(res.storeId).currentSpend || 0).toLocaleString() }}
								</p>
							</div>
							<div class="text-right">
								<p class="text-[9px] font-black text-slate-400 uppercase">å‰©é¤˜é¡åº¦</p>
								<p class="text-[10px] font-mono font-bold" 
								   :class="act.isFull ? 'text-red-500' : 'text-emerald-600'">
									{{ act.limitAmt === Infinity ? 'ç„¡ä¸Šé™' : '$' + (act.remaining || 0).toLocaleString() }}
								</p>
							</div>
						</div>

						<div v-if="act.limitAmt !== Infinity" class="relative w-full h-1.5 bg-slate-200 rounded-full overflow-hidden">
							<div class="absolute top-0 left-0 h-full transition-all duration-1000 ease-out" 
								 :style="{ 
									width: (act.progress || 0) + '%', 
									backgroundColor: act.isFull ? '#ef4444' : ((act.progress || 0) > 80 ? '#f59e0b' : '#10b981') 
								 }">
							</div>
						</div>

						<div class="flex justify-between mt-1">
							<span class="text-[8px] font-black text-slate-400">{{ Math.round(act.progress || 0) }}%</span>
							<span class="text-[8px] font-black text-slate-400 italic">
								ä¸Šé™ {{ act.limitAmt === Infinity ? 'âˆ' : '$' + (act.limitAmt || 0).toLocaleString() }}
							</span>
						</div>
					</div>
				</div>

				<div v-else-if="res.limitAmt && res.limitAmt !== Infinity" class="mt-4 bg-slate-50 p-3 rounded-2xl border border-slate-100">
					<div class="flex justify-between mb-1 text-[10px] font-bold">
						<span class="text-slate-400">ç´¯ç©æ¶ˆè²»é€²åº¦</span>
						<span class="text-slate-700">${{ (getCardStorage(res.storeId).currentSpend || 0).toLocaleString() }} / ${{ res.limitAmt.toLocaleString() }}</span>
					</div>
					<div class="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden">
						<div class="h-full bg-emerald-500 transition-all duration-1000" 
							 :style="{ width: Math.min(100, ((getCardStorage(res.storeId).currentSpend || 0) / res.limitAmt) * 100) + '%' }">
						</div>
					</div>
				</div>

				<div v-else-if="res && res.limitAmt" class="mt-4 bg-slate-50 p-4 rounded-3xl border border-slate-100">
					</div>
            </div>
        </div>
    </div>

    <transition name="modal">
        <div v-if="detailCard" class="fixed inset-0 z-[100] flex items-end justify-center px-4 pb-10">
            <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" @click="detailCard = null"></div>
            <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 relative z-10 border-t-8 border-amber-400 max-h-[80vh] overflow-y-auto">
                <div class="flex items-center gap-3 mb-6">
                    <div :class="['w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shadow-lg', detailCard.iconColor]">
                        <i :class="detailCard.icon"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-800">{{ detailCard.name }}</h3>
                        <p class="text-xs font-bold text-blue-600">{{ detailCard.plan }}</p>
                    </div>
                </div>
                
                <div class="space-y-6">
					<!--
                    <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-2">æ¬Šç›Šèªªæ˜</p>
                        <p class="text-sm font-bold text-slate-700 leading-relaxed">{{ detailCard.planDesc }}</p>
                    </div>
 					-->
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-1">é©ç”¨é€šè·¯è©³ç´°æ¸…å–®</p>
                        <div class="space-y-3">
                            <div v-for="group in detailCard.dynamicScope" :key="group.title" class="mb-4">
								<p class="text-sm font-black text-slate-800">{{ group.title }}</p>
								<p class="text-xs text-slate-500 mt-1">{{ group.shops }}</p>
							</div>
                        </div>
                    </div>

                    <div class="bg-amber-50 p-5 rounded-3xl border border-amber-100">
                        <p class="text-[10px] font-black text-amber-600 uppercase mb-1">é¡åº¦èˆ‡å›é¥‹é¡å‹</p>
                        <p class="text-sm font-bold text-amber-900 leading-tight">{{ detailCard.limit }}</p>
                        <p class="text-[10px] text-amber-700 mt-2 font-bold">é»æ•¸æ€§è³ªï¼š{{ detailCard.pointType }}</p>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="updateCard" class="fixed inset-0 z-[100] flex items-end justify-center px-4 pb-10">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="updateCard = null"></div>
            <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl relative z-10 border-t-8 border-amber-400">
                <h3 class="text-2xl font-black text-slate-800 mb-2 text-center">ç´¯åŠ æ¶ˆè²»é‡‘é¡</h3>
                <p class="text-center text-xs font-bold text-slate-400 mb-6">{{ updateCard.name }} ({{ updateCard.plan }})</p>
                
                <div class="bg-slate-50 rounded-3xl p-6 mb-6">
                    <p class="text-center text-[10px] font-black text-slate-400 uppercase mb-2">è¼¸å…¥æœ¬æ¬¡æ¶ˆè²»é‡‘é¡</p>
                    <input v-model.number="tempAmount" type="number" class="w-full bg-transparent font-mono font-bold text-4xl text-center outline-none focus:text-amber-500 transition">
                </div>

                <button @click="confirmUpdate" :disabled="isSyncing" class="w-full bg-slate-900 text-amber-400 py-5 rounded-[2rem] font-black text-lg flex items-center justify-center gap-3 active:scale-95 transition">
                    <i v-if="isSyncing" class="fas fa-spinner sync-loading"></i>
                    {{ isSyncing ? 'åŒæ­¥è‡³é›²ç«¯...' : 'ç¢ºèªç´¯åŠ é‡‘é¡' }}
                </button>
                <button @click="resetCard" :disabled="isSyncing" class="w-full text-red-400 text-[11px] font-black underline mt-6 opacity-50 hover:opacity-100 transition">æœ¬æœˆæ¶ˆè²»å¼·åˆ¶æ­¸é›¶</button>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="showSettings" class="fixed inset-0 z-[100] flex items-center justify-center px-4">
            <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" @click="showSettings = false"></div>
            <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl relative z-10 border-t-8 border-amber-400">
                <h3 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><i class="fas fa-database text-amber-500"></i> é›²ç«¯åŒæ­¥è¨­å®š</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-1">GAS WebApp URL</label>
                        <input v-model="config.gasUrl" type="text" class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-xs outline-none focus:border-amber-400" placeholder="https://script.google.com/...">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Google Sheet ID</label>
                        <input v-model="config.sheetId" type="text" class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-xs outline-none focus:border-amber-400" placeholder="è©¦ç®—è¡¨é•·çš„ ID å­—ä¸²">
                    </div>
                    <div class="bg-amber-50 p-4 rounded-2xl text-[10px] text-amber-700 font-bold leading-relaxed">
                        <i class="fas fa-info-circle mr-1"></i> è¨­å®šå¾Œï¼Œåˆ·å¡é‡‘é¡å°‡è‡ªå‹•å„²å­˜æ–¼æ‚¨çš„ Google è©¦ç®—è¡¨ï¼Œé”æˆå¤šè£ç½®åŒæ­¥æ•ˆæœã€‚
                    </div>
                    <button @click="saveSettings" class="w-full bg-slate-900 text-amber-400 py-4 rounded-2xl font-black mt-4 active:scale-95 transition">å„²å­˜ä¸¦ç«‹å³é€£ç·š</button>
                </div>
            </div>
        </div>
    </transition>
</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        // --- è¨­å®šèˆ‡ç‹€æ…‹ ---
        const config = ref({ 
            gasUrl: localStorage.getItem('cm_gasUrl') || '', 
            sheetId: localStorage.getItem('cm_sheetId') || '' 
        });
        const storageData = ref(JSON.parse(localStorage.getItem('cardMaster_v1.3')) || {});
        const skInput = ref(''); 
        const amount = ref(1000); 
        const uniCount = ref(5);
        const isSyncing = ref(false); 
        const showSettings = ref(false); 
        const showSuggestions = ref(false);
        const toast = ref({ show: false, msg: '', type: 'success' });
        const detailCard = ref(null); 
        const updateCard = ref(null); 
        const tempAmount = ref(0);

        // --- å•†åº—è³‡æ–™åº« ---
        const shopDatabase = [
            { name: 'å°æ–°Pay', category: 'æ”¯ä»˜æ–¹å¼' },{ name: 'å°ç£Pay', category: 'æ”¯ä»˜æ–¹å¼' },{ name: 'å°æ–°Pay+', category: 'æ”¯ä»˜æ–¹å¼' },
			{ name: 'LINE Pay', category: 'æ”¯ä»˜æ–¹å¼' },{ name: '7-11', category: 'è¶…å•†é‡è²©' },{ name: 'å…¨å®¶', category: 'è¶…å•†é‡è²©' },
			{ name: 'å®¶æ¨‚ç¦', category: 'è¶…å•†é‡è²©' },{ name: 'å¤§è²·å®¶', category: 'è¶…å•†é‡è²©' },{ name: 'å”å‰è»»å¾·', category: 'è¶…å•†é‡è²©' },
			{ name: 'LOPIA', category: 'è¶…å•†é‡è²©' },{ name: 'å°éµ', category: 'é€šå‹¤äº¤é€š' },{ name: 'é«˜éµ', category: 'é€šå‹¤äº¤é€š' },
			{ name: 'å°ç£å¤§è»ŠéšŠ', category: 'é€šå‹¤äº¤é€š' },{ name: 'LINEGO', category: 'é€šå‹¤äº¤é€š' },{ name: 'Yoxi', category: 'é€šå‹¤äº¤é€š' },
			{ name: 'Uber', category: 'é€šå‹¤äº¤é€š' },{ name: 'å°ç£Bolt', category: 'é€šå‹¤äº¤é€š' },{ name: 'ä¸­æ²¹ç›´ç‡Ÿ', category: 'åŠ æ²¹å……é›»' },
			{ name: 'å…¨åœ‹åŠ æ²¹', category: 'åŠ æ²¹å……é›»' },{ name: 'å…¨åœ‹ç‰¹æ€¥é›»', category: 'åŠ æ²¹å……é›»' },{ name: 'æºé»EVOASIS', category: 'åŠ æ²¹å……é›»' },
			{ name: 'è¯åŸé›»èƒ½EVALUE', category: 'åŠ æ²¹å……é›»' },{ name: 'USPACE', category: 'åŠ æ²¹å……é›»' },{ name: 'Autopass(è»Šéº»å‰)', category: 'åŠ æ²¹å……é›»' },
			{ name: 'å¯¶é›…', category: 'è—¥å¦è—¥å±€' },{ name: 'åº·æ˜¯ç¾', category: 'è—¥å¦è—¥å±€' },{ name: 'å±ˆè‡£æ°', category: 'è—¥å¦è—¥å±€' },
			{ name: 'æä¸€é†«ç™‚', category: 'è—¥å¦è—¥å±€' },{ name: 'å¤§æ¨¹è—¥å±€', category: 'è—¥å¦è—¥å±€' },{ name: 'ä¸ä¸è—¥å±€', category: 'è—¥å¦è—¥å±€' },
			{ name: 'ä½‘å…¨ä¿å¥è—¥å¦', category: 'è—¥å¦è—¥å±€' },{ name: 'å¥åº·äººç”Ÿè—¥å±€', category: 'è—¥å¦è—¥å±€' },{ name: 'æ–°å…‰ä¸‰è¶Š', category: 'æŒ‡å®šç™¾è²¨' },
			{ name: 'é æ±ç™¾è²¨', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'é æ±SOGO', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'æ¼¢ç¥å·¨è›‹', category: 'æŒ‡å®šç™¾è²¨' },
			{ name: 'æ¼¢ç¥ç™¾è²¨', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'å¾®é¢¨', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'å°åŒ—101', category: 'æŒ‡å®šç™¾è²¨' },
			{ name: 'é æ±å·¨åŸ', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'å»£ä¸‰SOGO', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'å—ç´¡è³¼ç‰©ä¸­å¿ƒ', category: 'æŒ‡å®šç™¾è²¨' },
			{ name: 'èª å“ç”Ÿæ´»', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'äº¬ç«™', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'ä¸‰å‰µç”Ÿæ´»', category: 'æŒ‡å®šç™¾è²¨' },
			{ name: 'å¤¢æ™‚ä»£', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'çµ±ä¸€æ™‚ä»£', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'ä¸­å‹ç™¾è²¨', category: 'æŒ‡å®šç™¾è²¨' },
			{ name: 'Mitsui Shopping Park LaLaport(å—æ¸¯/å°ä¸­)', category: 'æŒ‡å®šç™¾è²¨' },{ name: 'MITSUI OUTLET PARK (æ—å£/å°ä¸­æ¸¯/å°å—)', category: 'æŒ‡å®šOutlet' },{ name: 'è¯æ³°åå“åŸ', category: 'æŒ‡å®šOutlet' },
			{ name: 'SKM Park Outlets', category: 'æŒ‡å®šOutlet' },{ name: 'IKEA', category: 'å±…å®¶è£ä¿®' },{ name: 'ç‰¹åŠ›å±‹', category: 'å±…å®¶è£ä¿®' },
			{ name: 'HOLA', category: 'å±…å®¶è£ä¿®' },{ name: 'å®œå¾—åˆ©', category: 'å±…å®¶è£ä¿®' },{ name: 'ç‘ªé»‘å®¶å±…', category: 'å±…å®¶è£ä¿®' },
			{ name: 'UNIQLO', category: 'æ™‚å°šå“å‘³' },{ name: 'GU', category: 'æ™‚å°šå“å‘³' },{ name: 'ZARA', category: 'æ™‚å°šå“å‘³' },
			{ name: 'NET', category: 'æ™‚å°šå“å‘³' },{ name: 'lululemon', category: 'æ™‚å°šå“å‘³' },{ name: 'ç‹å“ç˜‹Pay', category: 'å…¨è‡ºé¤é£²' },
			{ name: 'Uber Eats', category: 'å¤–é€å¹³å°' },{ name: 'Foodpanda', category: 'å¤–é€å¹³å°' },{ name: 'æ‹“å…ƒå”®ç¥¨', category: 'è³¼ç¥¨å¨›æ¨‚' },
			{ name: 'KKTIX', category: 'è³¼ç¥¨å¨›æ¨‚' },{ name: 'å¹´ä»£å”®ç¥¨', category: 'è³¼ç¥¨å¨›æ¨‚' },{ name: 'å¯¬å®å”®ç¥¨', category: 'è³¼ç¥¨å¨›æ¨‚' },
			{ name: 'OPENTIXå…©å»³é™¢æ–‡åŒ–ç”Ÿæ´»', category: 'è³¼ç¥¨å¨›æ¨‚' },{ name: 'FunNow', category: 'è³¼ç¥¨å¨›æ¨‚' },{ name: 'éŒ¢æ«ƒ', category: 'æŒ‡å®šKTV' },
			{ name: 'å¥½æ¨‚è¿ª', category: 'æŒ‡å®šKTV' },{ name: 'ONCOR', category: 'æŒ‡å®šKTV' },{ name: 'sing!go', category: 'æŒ‡å®šKTV' },
			{ name: 'äº«æº«é¦¨', category: 'æŒ‡å®šKTV' },{ name: 'æ™¶è¯åœ‹éš›é…’åº—é›†åœ˜', category: 'æŒ‡å®šé£¯åº—' },{ name: 'é›²æœ—è§€å…‰', category: 'æŒ‡å®šé£¯åº—' },
			{ name: 'å°ç£è¬è±ªåœ‹éš›é›†åœ˜æ——ä¸‹é£¯åº—', category: 'æŒ‡å®šé£¯åº—' },{ name: 'ç…™æ³¢åœ‹éš›è§€å…‰é›†åœ˜', category: 'æŒ‡å®šé£¯åº—' },{ name: 'è€çˆºé…’åº—é›†åœ˜', category: 'æŒ‡å®šé£¯åº—' },
			{ name: 'ç¦è¯é›†åœ˜', category: 'æŒ‡å®šé£¯åº—' },{ name: 'æ¼¢ä¾†é£¯åº—äº‹æ¥­ç¾¤', category: 'æŒ‡å®šé£¯åº—' },{ name: 'å°åŒ—å›æ‚…é…’åº—', category: 'æŒ‡å®šé£¯åº—' },
			{ name: 'é«˜é›„æ´²éš›é…’åº—', category: 'æŒ‡å®šé£¯åº—' },{ name: 'è‡ºä¸­å‹¤ç¾æ´²éš›é…’åº—', category: 'æŒ‡å®šé£¯åº—' },{ name: 'ç¤æºªå¯’æ²é…’åº—', category: 'æŒ‡å®šé£¯åº—' },
			{ name: 'è¦çš®', category: 'ç¶²è³¼å¹³å°' },{ name: 'momo', category: 'ç¶²è³¼å¹³å°' },{ name: 'é…·æ¾(Coupang)', category: 'ç¶²è³¼å¹³å°' },
			{ name: 'PChome', category: 'ç¶²è³¼å¹³å°' },{ name: 'æ·˜å¯¶', category: 'ç¶²è³¼å¹³å°' },{ name: 'Amazon', category: 'ç¶²è³¼å¹³å°' },
			{ name: 'æ±æ£®', category: 'ç¶²è³¼å¹³å°' },{ name: 'åšå®¢ä¾†', category: 'ç¶²è³¼å¹³å°' },{ name: 'Richart Mart', category: 'ç¶²è³¼å¹³å°' },
			{ name: 'PayEasy', category: 'ç¶²è³¼å¹³å°' },{ name: 'iHerb', category: 'ç¶²è³¼å¹³å°' },{ name: 'SHEIN', category: 'ç¶²è³¼å¹³å°' },
			{ name: 'Farfetch', category: 'ç¶²è³¼å¹³å°' },{ name: 'Olive Young', category: 'ç¶²è³¼å¹³å°' },{ name: 'çŸ¥è­˜è¡›æ˜Ÿ', category: 'ç·šä¸Šèª²ç¨‹' },
			{ name: 'Amazing Talker', category: 'ç·šä¸Šèª²ç¨‹' },{ name: 'Tutor ABC', category: 'ç·šä¸Šèª²ç¨‹' },{ name: 'Hahow', category: 'ç·šä¸Šèª²ç¨‹' },
			{ name: 'PressPlay', category: 'ç·šä¸Šèª²ç¨‹' },{ name: 'MyCard', category: 'éŠæˆ²å½±éŸ³' },{ name: 'éŠæˆ²æ©˜å­', category: 'éŠæˆ²å½±éŸ³' },
			{ name: 'Steam', category: 'éŠæˆ²å½±éŸ³' },{ name: 'PlayStation', category: 'éŠæˆ²å½±éŸ³' },{ name: 'Nintendo', category: 'éŠæˆ²å½±éŸ³' },
			{ name: 'Netflix', category: 'éŠæˆ²å½±éŸ³' },{ name: 'Disney+', category: 'éŠæˆ²å½±éŸ³' },{ name: 'ChatGPT', category: 'AIæœå‹™' },
			{ name: 'Notion', category: 'AIæœå‹™' },{ name: 'Canva', category: 'AIæœå‹™' },{ name: 'Perplexity', category: 'AIæœå‹™' },
			{ name: 'Claude', category: 'AIæœå‹™' },{ name: 'ä¸­è¯èˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'é•·æ¦®èˆªç©º', category: 'èˆªç©ºå…¬å¸' },
			{ name: 'æ˜Ÿå®‡èˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'å°ç£è™èˆª', category: 'èˆªç©ºå…¬å¸' },{ name: 'åœ‹æ³°èˆªç©º', category: 'èˆªç©ºå…¬å¸' },
			{ name: 'è¯ä¿¡èˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'ç«‹æ¦®èˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'æ¨‚æ¡ƒèˆªç©º', category: 'èˆªç©ºå…¬å¸' },
			{ name: 'é˜¿è¯é…‹èˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'äºæ´²èˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'é…·èˆª', category: 'èˆªç©ºå…¬å¸' },
			{ name: 'æ·æ˜Ÿèˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'æ–°åŠ å¡èˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'æ—¥æœ¬èˆªç©º', category: 'èˆªç©ºå…¬å¸' },
			{ name: 'è¶Šæ·èˆªç©º', category: 'èˆªç©ºå…¬å¸' },{ name: 'Uber', category: 'æµ·å¤–äº¤é€š/ç¶²è·¯' },{ name: 'Grab', category: 'æµ·å¤–äº¤é€š/ç¶²è·¯' },
			{ name: 'SUICA', category: 'æµ·å¤–äº¤é€š/ç¶²è·¯' },{ name: 'ICOCA', category: 'æµ·å¤–äº¤é€š/ç¶²è·¯' },{ name: 'PASMO', category: 'æµ·å¤–äº¤é€š/ç¶²è·¯' },
			{ name: 'WOWPASS', category: 'æµ·å¤–äº¤é€š/ç¶²è·¯' },{ name: 'AIRSIM', category: 'æµ·å¤–äº¤é€š/ç¶²è·¯' },{ name: 'Klook', category: 'è¨‚æˆ¿å¹³å°' },
			{ name: 'KKday', category: 'è¨‚æˆ¿å¹³å°' },{ name: 'Agoda', category: 'è¨‚æˆ¿å¹³å°' },{ name: 'Booking.com', category: 'è¨‚æˆ¿å¹³å°' },
			{ name: 'Trip.com', category: 'è¨‚æˆ¿å¹³å°' },{ name: 'Airbnb', category: 'è¨‚æˆ¿å¹³å°' },
			{ name: 'Hotels.com', category: 'è¨‚æˆ¿å¹³å°' },{ name: 'Expedia', category: 'è¨‚æˆ¿å¹³å°' },{ name: 'é›„ç…æ—…éŠ', category: 'æ—…è¡Œç¤¾' },
			{ name: 'æ˜“éŠç¶²', category: 'æ—…è¡Œç¤¾' },{ name: 'æ±å—æ—…éŠ', category: 'æ—…è¡Œç¤¾' },{ name: 'å¯æ¨‚æ—…éŠ', category: 'æ—…è¡Œç¤¾' },
			{ name: 'é•·æ±å‡æœŸ', category: 'æ—…è¡Œç¤¾' },{ name: 'äº”ç¦æ—…éŠ', category: 'æ—…è¡Œç¤¾' },{ name: 'å–œé´»å‡æœŸ', category: 'æ—…è¡Œç¤¾' },
			{ name: 'æ˜“é£›æ—…éŠ', category: 'æ—…è¡Œç¤¾' },{ name: 'ç‡¦æ˜Ÿæ—…éŠ', category: 'æ—…è¡Œç¤¾' },{ name: 'åŠ åˆ©åˆ©æ—…è¡Œç¤¾', category: 'æ—…è¡Œç¤¾' },
			{ name: 'é³³å‡°åœ‹éš›æ—…è¡Œç¤¾', category: 'æ—…è¡Œç¤¾' },{ name: 'å±±å¯Œæ—…éŠ', category: 'æ—…è¡Œç¤¾' },{ name: 'è¡Œå¥æ—…éŠ', category: 'æ—…è¡Œç¤¾' },
			{ name: 'æµ·å¤–', category: 'æµ·å¤–æ¶ˆè²»' }
        ];

        const getShopsByCategory = (cat) => shopDatabase.filter(d => d.category === cat).map(d => d.name).join('ï½œ');
		// å‚³å…¥ rates é™£åˆ—èˆ‡ç›®å‰å·²åˆ·é‡‘é¡ï¼Œå›å‚³å‰©é¤˜å¯å¾—çš„ç¸½è¶´æ•¸
		const getEffectiveRate = (rates, currentSpent) => {
			let totalRate = 0;
			rates.forEach(r => {
				// å¦‚æœè©²é …æ²’æœ‰é‡‘é¡é™åˆ¶ï¼Œæˆ–ç›®å‰åˆ·å¡é¡é‚„æ²’è¶…éä¸Šé™ï¼Œå°±åŠ ä¸Šè©²é …è¶´æ•¸
				if (!r.limitAmt || currentSpent < r.limitAmt) {
					totalRate += r.rate;
				}
			});
			return totalRate;
		};
		
		const getCardStorage = (id) => {
			if (!id) return { currentSpend: 0 };
			// å¦‚æœ storageData[id] ä¸å­˜åœ¨ï¼Œå°±å›å‚³ä¸€å€‹é è¨­ç‰©ä»¶
			if (!storageData.value[id]) {
				return { currentSpend: 0 };
			}
			return storageData.value[id];
		};
        // --- æ ¸å¿ƒå¡ç‰‡é‚è¼¯ ---
		
		//å°æ–°
		const getRichart = (cat, shop, spent = 0) => {
			const s = shop.toUpperCase();
			const currentSpent = Number(spent) || 0;
			let base = { bank: 'å°æ–°éŠ€è¡Œ', name: 'Richart', pointType: 'å°æ–°Point', storeId: 'richart' };
			
			// æ–¹æ¡ˆåˆ†é¡
			const groups = {
				daily: ['è¶…å•†é‡è²©', 'é€šå‹¤äº¤é€š', 'åŠ æ²¹å……é›»', 'è—¥å¦è—¥å±€'],
				eat: ['å…¨è‡ºé¤é£²', 'å¤–é€å¹³å°', 'è³¼ç¥¨å¨›æ¨‚', 'æŒ‡å®šKTV', 'æŒ‡å®šé£¯åº—'],
				big: ['æŒ‡å®šç™¾è²¨', 'æŒ‡å®šOutlet', 'å±…å®¶è£ä¿®', 'æ™‚å°šå“å‘³'],
				digital: ['ç¶²è³¼å¹³å°', 'éŠæˆ²å½±éŸ³', 'AIæœå‹™', 'ç·šä¸Šèª²ç¨‹'],
				travel: ['æµ·å¤–æ¶ˆè²»', 'èˆªç©ºå…¬å¸', 'è¨‚æˆ¿å¹³å°', 'æ—…è¡Œç¤¾']
			};

			// ä¸Šé™è¨ˆç®—å·¥å…·
			const processDetails = (details) => {
				return details.map(item => {
					const rawLimit = (item.pointLimit && item.rate > 0) ? (item.pointLimit / (item.rate / 100)) : Infinity;
					const calculatedLimit = rawLimit === Infinity ? Infinity : Math.floor(rawLimit);
					const isFull = calculatedLimit !== Infinity && currentSpent >= calculatedLimit;
					return {
						...item,
						limitAmt: calculatedLimit,
						activeRate: isFull ? 0 : item.rate,
						remaining: calculatedLimit === Infinity ? Infinity : Math.max(0, calculatedLimit - currentSpent),
						progress: calculatedLimit === Infinity ? 0 : Math.min(100, (currentSpent / calculatedLimit) * 100),
						isFull: isFull
					};
				});
			};

			const generateScope = (categoryList) => {
				return categoryList.map(c => {
					let shops = typeof getShopsByCategory === 'function' ? getShopsByCategory(c) : c;
					if (c === 'è¶…å•†é‡è²©') shops = '7-11åŠå…¨å®¶(é™å°æ–°Payæ”¯ä»˜)';
					return { title: c, shops: shops };
				});
			};

			let rawDetails = [];
			let planName = '';
			let scopeData = [];

			// 1. æŒ‡å®šæ”¯ä»˜åˆ¤æ–· (ä»¥ 3.8% ç‚ºä¾‹ï¼š0.3% åŸºæœ¬ + 3.5% åŠ ç¢¼)
			if (s.includes('å°æ–°PAY')) {
				rawDetails = [
					{ name: 'åŸºæœ¬å›é¥‹', rate: 0.3, pointLimit: null },
					{ name: 'å°æ–°PayåŠ ç¢¼', rate: 3.5, pointLimit: null } // 1000 / 3.5% = 28,571
				];
				planName = 'ã€Payè‘—åˆ·ã€‘';
				scopeData = [{title:'æŒ‡å®šæ”¯ä»˜', shops:'å°æ–° Pay'}];
			} else if (s.includes('LINE PAY')) {
				rawDetails = [
					{ name: 'åŸºæœ¬å›é¥‹', rate: 0.3, pointLimit: null },
					{ name: 'LINE PayåŠ ç¢¼', rate: 2.0, pointLimit: null }
				];
				planName = 'ã€Payè‘—åˆ·ã€‘';
				scopeData = [{title:'æŒ‡å®šæ”¯ä»˜', shops:'LINE Pay'}];
			} 
			// 2. äº”å¤§æ¬Šç›Šåˆ¤æ–·
			else {
				const matchedGroup = Object.keys(groups).find(key => groups[key].includes(cat));
				if (matchedGroup) {
					rawDetails = [
						{ name: 'åŸºæœ¬å›é¥‹', rate: 0.3, pointLimit: null },
						{ name: 'æ–¹æ¡ˆåŠ ç¢¼', rate: 3.0, pointLimit: null } // 1000 / 3% = 33,333
					];
					const planMap = { daily: 'å¤©å¤©åˆ·', eat: 'å¥½é¥—åˆ·', big: 'å¤§ç­†åˆ·', digital: 'æ•¸è¶£åˆ·', travel: 'ç©æ—…åˆ·' };
					planName = `ã€${planMap[matchedGroup]}ã€‘`;
					scopeData = generateScope(groups[matchedGroup]);
				} else {
					rawDetails = [{ name: 'åŸºæœ¬å›é¥‹', rate: 0.3, pointLimit: null }];
					planName = 'ä¸€èˆ¬æ¶ˆè²»';
					scopeData = [{title:'ä¸€èˆ¬é€šè·¯', shops:'éæŒ‡å®šæ–¹æ¡ˆæ¶ˆè²»'}];
				}
			}

			const finalDetails = processDetails(rawDetails);
			const effectiveTotalRate = finalDetails.reduce((sum, item) => sum + item.activeRate, 0);
			const remainingCaps = finalDetails.filter(d => d.limitAmt !== Infinity && !d.isFull);
			const minRemaining = remainingCaps.length > 0 ? Math.min(...remainingCaps.map(c => c.remaining)) : Infinity;

			return { 
				...base, 
				rate: effectiveTotalRate, 
				rateDetails: finalDetails,
				canBrush: minRemaining === Infinity ? Infinity : Math.floor(minRemaining),
				plan: planName,
				note: `å„æ´»å‹•ä¸Šé™ç¨ç«‹è¨ˆç®—`,
				dynamicScope: scopeData
			};
		};
		
		//ä¸­ä¿¡UNI
		const getCTBC_UNI = (cat, shop, count, spent = 0) => {
			const s = shop.toUpperCase();
			const currentSpent = Number(spent) || 0;
			const missionRate = count >= 2 ? (count - 1) : 0;
			
			let base = { bank: 'ä¸­åœ‹ä¿¡è¨—', name: 'UniOpen å¡', pointType: 'OpenPoint', storeId: 'ctbc_uni' };

			const processDetails = (details) => {
				return details.map(item => {
					// ä¸Šé™å–æ•´æ•¸ (Math.floor)
					const rawLimit = (item.pointLimit && item.rate > 0) ? (item.pointLimit / (item.rate / 100)) : Infinity;
					const calculatedLimit = rawLimit === Infinity ? Infinity : Math.floor(rawLimit);

					const isFull = calculatedLimit !== Infinity && currentSpent >= calculatedLimit;
					
					return {
						...item,
						limitAmt: calculatedLimit,
						activeRate: isFull ? 0 : item.rate,
						remaining: calculatedLimit === Infinity ? Infinity : Math.max(0, calculatedLimit - currentSpent),
						progress: calculatedLimit === Infinity ? 0 : Math.min(100, (currentSpent / calculatedLimit) * 100),
						isFull: isFull
					};
				});
			};

			const uniGroups = {
				'çµ±ä¸€é›†åœ˜': ['7-11', 'åº·æ˜¯ç¾', 'å¤¢æ™‚ä»£', 'çµ±ä¸€æ™‚ä»£ç™¾è²¨', 'DREAM PLAZA', 'UNIKCY',
							'ç²å»Šæ»¿è—', 'BEING sport', 'BEING spa', 'BEING fit', 'æ˜Ÿå·´å…‹', '21ä¸–ç´€', 
							'Mister Donut', 'COLD STONEé…·è–çŸ³å†°æ·‡æ·‹', 'Semeurè–å¨œ', 'å®¶æ¨‚ç¦', 
							'Mia Câ€˜bon', 'Yahooè³¼ç‰©', 'åšå®¢ä¾†', 'è–å¾·ç§‘æ–¯', 'çµ±ä¸€ç”Ÿæ©Ÿ', 'é€Ÿé‚æ¨‚', 
							'foodomo', 'é®®æ‹¾ç¶²', 'DUSKIN', 'é»‘è²“å®…æ€¥ä¾¿', 'ibonå”®ç¥¨ç³»çµ±', 'çµ±ä¸€æ¸¡å‡æ‘', 'å°åŒ—Wé£¯åº—', 
							'å°åŒ—æ™‚ä»£å¯“æ‰€', 'çµ±ä¸€å‹å‹æ—…è¡Œç¤¾'
				] 
			};
			const isUni = Object.values(uniGroups).flat().some(k => s.includes(k.toUpperCase()));
			// å–å¾—æ‰€æœ‰å•†åº—ä¸¦è½‰æˆå­—ä¸²
			const allUniShopsStr = uniGroups['çµ±ä¸€é›†åœ˜'].join('ã€');
			
			let rawDetails = [];
			let scopeShops = ''; // ç”¨ä¾†å­˜æ”¾é¡¯ç¤ºç”¨çš„å•†åº—å­—ä¸²

			if (cat === 'æµ·å¤–æ¶ˆè²»' || s.includes('æµ·å¤–')) {
				rawDetails = [
					{ name: 'åœ‹å¤–ä¸€èˆ¬', rate: 2, pointLimit: null },
					{ name: 'åœ‹å¤–å¯¦é«”å•†åº—', rate: 1, pointLimit: null },
					{ name: 'åœ‹å¤–å¯¦é«”åŠ ç¢¼', rate: 8, pointLimit: 500 }
				];
				scopeShops = 'å…¨çƒåœ‹å¤–å¯¦é«”å•†åº—';
			} else  if (isUni) {
				rawDetails = [
					{ name: 'åœ‹å…§ä¸€èˆ¬', rate: 1, pointLimit: null },
					{ name: 'çµ±ä¸€ä¼æ¥­é›†åœ˜', rate: 2, pointLimit: 500 },
					{ name: 'æ¡é»ä»»å‹™', rate: missionRate, pointLimit: 500 },
					{ name: 'icash Pay', rate: 4, pointLimit: 150 }
				];
				scopeShops = allUniShopsStr;
			} else if (s.includes('ICASH PAY')) {
				rawDetails = [
					{ name: 'ä¸€èˆ¬æ¶ˆè²»', rate: 1, pointLimit: null },
					{ name: 'icash Pay', rate: 4, pointLimit: 150 }
				];
				scopeShops = 'icash Payä¸€èˆ¬æ¶ˆè²»é€šè·¯';
			} else {
				rawDetails = [
					{ name: 'ä¸€èˆ¬æ¶ˆè²»', rate: 1, pointLimit: null }
					//{ name: 'icash Pay', rate: 4, pointLimit: 150 }
				];
				scopeShops = 'åœ‹å…§ä¸€èˆ¬æ¶ˆè²»é€šè·¯';
			}

			const finalDetails = processDetails(rawDetails);
			const effectiveTotalRate = finalDetails.reduce((sum, item) => sum + item.activeRate, 0);

			const remainingCaps = finalDetails.filter(d => d.limitAmt !== Infinity && !d.isFull);
			const minRemaining = remainingCaps.length > 0 ? Math.min(...remainingCaps.map(c => c.remaining)) : Infinity;

			return { 
				...base, 
				rate: effectiveTotalRate,
				rateDetails: finalDetails,
				canBrush: minRemaining === Infinity ? Infinity : Math.floor(minRemaining),
				plan: s.includes('æµ·å¤–') ? 'åœ‹å¤–å¯¦é«” 11%' : (isUni ? 'çµ±ä¸€é›†åœ˜é€šè·¯' : 'ä¸€èˆ¬é€šè·¯'),
				note: `å„æ´»å‹•ä¸Šé™ç¨ç«‹è¨ˆç®—`,
				// --- è£œå›é—œéµçš„ dynamicScope æ¬„ä½ ---
				dynamicScope: [
					{ title: 'é©ç”¨ç¯„åœ', shops: scopeShops }
				]
			};
		};
				
		//è¯é‚¦
        const getFed = (cat, shop, spent = 0) => {
			const s = shop.toUpperCase();
			const currentSpent = Number(spent) || 0;
			let base = { bank: 'è¯é‚¦éŠ€è¡Œ', name: 'LINE Bank å¡', pointType: 'ç¾é‡‘', storeId: 'fed_lb' };

			// æ’é™¤è¶…å•†é‚è¼¯
			if (s.includes('7-11') || s.includes('å…¨å®¶')) {
				return { 
					...base, 
					rate: 0, 
					plan: 'ç„¡å›é¥‹', 
					note: 'æ’é™¤è¶…å•†', 
					rateDetails: [],
					dynamicScope: [{ title: 'æ’é™¤é€šè·¯', shops: '7-11ã€å…¨å®¶' }] 
				};
			}

			const processDetails = (details) => {
				return details.map(item => {
					const rawLimit = (item.pointLimit && item.rate > 0) ? (item.pointLimit / (item.rate / 100)) : Infinity;
					const calculatedLimit = rawLimit === Infinity ? Infinity : Math.floor(rawLimit);
					
					const isFull = calculatedLimit !== Infinity && currentSpent >= calculatedLimit;
					return {
						...item,
						limitAmt: calculatedLimit,
						activeRate: isFull ? 0 : item.rate,
						remaining: calculatedLimit === Infinity ? Infinity : Math.max(0, calculatedLimit - currentSpent),
						progress: calculatedLimit === Infinity ? 0 : Math.min(100, (currentSpent / calculatedLimit) * 100),
						isFull: isFull
					};
				});
			};

			const highRateShops = ['NETFLIX','MOMO','PCHOME','è¦çš®','é…·æ¾'];
			const isHighRate = highRateShops.some(k => s.includes(k));
			
			let rawDetails = isHighRate 
				? [
					//{ name: 'åœ‹å…§ä¸€èˆ¬', rate: 1, pointLimit: null },
					{ name: 'ç¶²è³¼åŠ ç¢¼', rate: 3, pointLimit: 300 } // $300 / 2% = 15,000 å…ƒ
				  ]
				: [{ name: 'åœ‹å…§ä¸€èˆ¬', rate: 1, pointLimit: null }];

			const finalDetails = processDetails(rawDetails);
			const effectiveTotalRate = finalDetails.reduce((sum, item) => sum + item.activeRate, 0);
			const remainingCaps = finalDetails.filter(d => d.limitAmt !== Infinity && !d.isFull);
			const minRemaining = remainingCaps.length > 0 ? Math.min(...remainingCaps.map(c => c.remaining)) : Infinity;

			return { 
				...base, 
				rate: effectiveTotalRate, 
				rateDetails: finalDetails,
				canBrush: minRemaining === Infinity ? Infinity : Math.floor(minRemaining),
				plan: isHighRate ? 'æŒ‡å®šç¶²è³¼åŠ ç¢¼' : 'ä¸€èˆ¬æ¶ˆè²»',
				note: `å„æ´»å‹•ä¸Šé™ç¨ç«‹è¨ˆç®—`,
				// è£œå› SHOP é¡¯ç¤º
				dynamicScope: [
					{ title: 'é©ç”¨ç¯„åœ', shops: isHighRate ? highRateShops.join('ã€') : 'åœ‹å…§ä¸€èˆ¬æ¶ˆè²»é€šè·¯' }
				]
			};
		};
		
		//åœ‹æ³°
        const getCube = (cat, shop, spent = 0) => {
			const s = shop.toUpperCase();
			const currentSpent = Number(spent) || 0;
			let base = { bank: 'åœ‹æ³°ä¸–è¯', name: 'é’å¹´ç°½å¸³å¡', pointType: 'ç¾é‡‘', storeId: 'cathay_youth' };

			// æ’é™¤è¶…å•†
			if (s.includes('7-11') || s.includes('å…¨å®¶')) {
				return { 
					...base, 
					rate: 0, 
					plan: 'ç„¡å›é¥‹', 
					note: 'æ’é™¤è¶…å•†', 
					rateDetails: [],
					dynamicScope: [{ title: 'æ’é™¤é€šè·¯', shops: '7-11ã€å…¨å®¶' }]
				};
			}

			const processDetails = (details) => {
				return details.map(item => {
					// è¨ˆç®—ä¸Šé™ä¸¦å–æ•´æ•¸
					const rawLimit = (item.pointLimit && item.rate > 0) ? (item.pointLimit / (item.rate / 100)) : Infinity;
					const calculatedLimit = rawLimit === Infinity ? Infinity : Math.floor(rawLimit);
					
					const isFull = calculatedLimit !== Infinity && currentSpent >= calculatedLimit;
					return {
						...item,
						limitAmt: calculatedLimit,
						activeRate: isFull ? 0 : item.rate,
						remaining: calculatedLimit === Infinity ? Infinity : Math.max(0, calculatedLimit - currentSpent),
						progress: calculatedLimit === Infinity ? 0 : Math.min(100, (currentSpent / calculatedLimit) * 100),
						isFull: isFull
					};
				});
			};

			let rawDetails = [];
			let scopeShops = '';

			if (s.includes('æµ·å¤–') || s.includes('å°éµ') || s.includes('é«˜éµ')) {
				rawDetails = [
					//{ name: 'åŸºæœ¬å›é¥‹', rate: 0.3, pointLimit: null },
					{ name: 'æŒ‡å®šæ¬Šç›ŠåŠ ç¢¼', rate: 3, pointLimit: 200 } 
				];
				scopeShops = 'æµ·å¤–æ¶ˆè²»ã€å°éµã€é«˜éµ';
			} else if (s.includes('LINE PAY')) {
				rawDetails = [
					//{ name: 'åŸºæœ¬å›é¥‹', rate: 0.3, pointLimit: null },
					{ name: 'LINE PAYæ”¯ä»˜åŠ ç¢¼', rate: 2, pointLimit: null } 
				];
				scopeShops = 'LINE Pay ç¶å®šæ”¯ä»˜';
			} else {
				rawDetails = [{ name: 'ä¸€èˆ¬æ¶ˆè²»', rate: 0.3, pointLimit: null }];
				scopeShops = 'åœ‹å…§ä¸€èˆ¬æ¶ˆè²»é€šè·¯';
			}

			const finalDetails = processDetails(rawDetails);
			const effectiveTotalRate = finalDetails.reduce((sum, item) => sum + item.activeRate, 0);
			const remainingCaps = finalDetails.filter(d => d.limitAmt !== Infinity && !d.isFull);
			const minRemaining = remainingCaps.length > 0 ? Math.min(...remainingCaps.map(c => c.remaining)) : Infinity;

			return { 
				...base, 
				rate: effectiveTotalRate, 
				rateDetails: finalDetails,
				canBrush: minRemaining === Infinity ? Infinity : Math.floor(minRemaining),
				plan: s.includes('LINE PAY') ? 'æ”¯ä»˜åŠ ç¢¼' : (rawDetails.length > 1 ? 'æŒ‡å®šæ¬Šç›ŠåŠ ç¢¼' : 'ä¸€èˆ¬æ¶ˆè²»'),
				note: `å„æ´»å‹•ä¸Šé™ç¨ç«‹è¨ˆç®—`,
				// è£œå› SHOP é¡¯ç¤º
				dynamicScope: [
					{ title: 'é©ç”¨ç¯„åœ', shops: scopeShops }
				]
			};
		};
		
		//ä¸­ä¿¡LINE PAY
        const getLINEPay = (cat, shop, spent = 0) => {
			const s = shop.toUpperCase();
			const currentSpent = Number(spent) || 0;
			let base = { bank: 'ä¸­åœ‹ä¿¡è¨—', name: 'LINE Pay å¡', pointType: 'LINE Points', storeId: 'ctbc_lp' };

			// æ’é™¤è¶…å•†
			if (s.includes('7-11') || s.includes('å…¨å®¶')) {
				return { 
					...base, 
					rate: 0, 
					plan: 'ç„¡å›é¥‹', 
					note: 'æ’é™¤è¶…å•†', 
					rateDetails: [],
					dynamicScope: [{ title: 'æ’é™¤é€šè·¯', shops: '7-11ã€å…¨å®¶' }]
				};
			}

			const processDetails = (details) => {
				return details.map(item => {
					// è¨ˆç®—ä¸Šé™ä¸¦å–æ•´æ•¸
					const rawLimit = (item.pointLimit && item.rate > 0) ? (item.pointLimit / (item.rate / 100)) : Infinity;
					const calculatedLimit = rawLimit === Infinity ? Infinity : Math.floor(rawLimit);
					
					const isFull = calculatedLimit !== Infinity && currentSpent >= calculatedLimit;
					return {
						...item,
						limitAmt: calculatedLimit,
						activeRate: isFull ? 0 : item.rate,
						remaining: calculatedLimit === Infinity ? Infinity : Math.max(0, calculatedLimit - currentSpent),
						progress: calculatedLimit === Infinity ? 0 : Math.min(100, (currentSpent / calculatedLimit) * 100),
						isFull: isFull
					};
				});
			};

			let rawDetails = [];
			let scopeShops = '';

			if (s.includes('æµ·å¤–')) {
				rawDetails = [{ name: 'æµ·å¤–åŠ ç¢¼', rate: 2.8, pointLimit: null }]; // æµ·å¤– 2.8% ç„¡ä¸Šé™
				scopeShops = 'å…¨çƒåœ‹å¤–æ¶ˆè²»';
			} else {
				rawDetails = [{ name: 'åœ‹å…§ä¸€èˆ¬', rate: 1, pointLimit: null }]; // åœ‹å…§ 1% ç„¡ä¸Šé™
				scopeShops = 'åœ‹å…§ä¸€èˆ¬æ¶ˆè²»é€šè·¯';
			}

			const finalDetails = processDetails(rawDetails);
			const effectiveTotalRate = finalDetails.reduce((sum, item) => sum + item.activeRate, 0);
			const remainingCaps = finalDetails.filter(d => d.limitAmt !== Infinity && !d.isFull);
			const minRemaining = remainingCaps.length > 0 ? Math.min(...remainingCaps.map(c => c.remaining)) : Infinity;

			return { 
				...base, 
				rate: effectiveTotalRate, 
				rateDetails: finalDetails,
				canBrush: minRemaining === Infinity ? Infinity : Math.floor(minRemaining),
				plan: s.includes('æµ·å¤–') ? 'æµ·å¤–æ¶ˆè²»' : 'ä¸€èˆ¬æ¶ˆè²»',
				note: `å›é¥‹ç„¡ä¸Šé™`,
				dynamicScope: [
					{ title: 'é©ç”¨ç¯„åœ', shops: scopeShops }
				]
			};
		};

        // --- åŒæ­¥èˆ‡äº’å‹•åŠŸèƒ½ ---
        const showToast = (msg, type = 'success') => { toast.value = { show: true, msg, type }; setTimeout(() => toast.value.show = false, 2500); };

        const syncFromCloud = async () => {
            if (!config.value.gasUrl || !config.value.sheetId) return;
            isSyncing.value = true;
            try {
                const res = await fetch(`${config.value.gasUrl}?sId=${config.value.sheetId}&t=${Date.now()}`);
                const data = await res.json();
                if (data && !data.error) {
                    storageData.value = data;
                    localStorage.setItem('cardMaster_v1.3', JSON.stringify(data));
                    showToast("åŒæ­¥æˆåŠŸ");
                }
            } catch (e) { showToast("é€£ç·šå¤±æ•—", "error"); } finally { isSyncing.value = false; }
        };

        const confirmUpdate = async () => {
            if (!config.value.gasUrl || isSyncing.value) return;
            const sid = updateCard.value.storeId;
            const addValue = Number(tempAmount.value) || 0;
            isSyncing.value = true;
            try {
                if (!storageData.value[sid]) storageData.value[sid] = { currentSpend: 0 };
                storageData.value[sid].currentSpend += addValue;
                
                await fetch(config.value.gasUrl, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ ...storageData.value, _sheetId: config.value.sheetId })
                });
                
                localStorage.setItem('cardMaster_v1.3', JSON.stringify(storageData.value));
                showToast(`å·²ç´¯åŠ  $${addValue}`);
                updateCard.value = null;
            } catch (e) { showToast("æ›´æ–°å¤±æ•—", "error"); } finally { isSyncing.value = false; }
        };

        const resetCard = async () => {
            if (!config.value.gasUrl || isSyncing.value || !confirm('ç¢ºå®šæ¸…ç©ºæ­¤å¡æœ¬æœˆç´¯è¨ˆï¼Ÿ')) return;
            const sid = updateCard.value.storeId;
            isSyncing.value = true;
            try {
                if (storageData.value[sid]) storageData.value[sid].currentSpend = 0;
                await fetch(config.value.gasUrl, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ ...storageData.value, _sheetId: config.value.sheetId })
                });
                localStorage.setItem('cardMaster_v1.3', JSON.stringify(storageData.value));
                showToast("æ•¸æ“šå·²æ­¸é›¶");
                updateCard.value = null;
            } catch (e) { showToast("æ­¸é›¶å¤±æ•—", "error"); } finally { isSyncing.value = false; }
        };

        const saveSettings = () => {
            localStorage.setItem('cm_gasUrl', config.value.gasUrl);
            localStorage.setItem('cm_sheetId', config.value.sheetId);
			localStorage.setItem('last_update_month', currentMonthKey);
            showSettings.value = false;
            syncFromCloud();
        };
		
		// åœ¨ setup() å…§åŠ å…¥æª¢æŸ¥è·¨æœˆçš„é‚è¼¯
		const checkAndResetMonthly = async () => {
			// 1. åŸºæœ¬æª¢æŸ¥ï¼šå¦‚æœæ²’æœ‰è¨­å®š GAS URL å‰‡ä¸åŸ·è¡Œ
			if (!config.value.gasUrl) return;

			const now = new Date();
			const currentMonthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
			const lastMonthKey = localStorage.getItem('last_update_month');

			// 2. æ¯”å°æœˆä»½
			if (lastMonthKey && lastMonthKey !== currentMonthKey) {
				console.log("åµæ¸¬åˆ°è·¨æœˆï¼Œæ­£åœ¨åŸ·è¡Œå…¨å¡ç‰‡è‡ªå‹•è¦é›¶...");
				
				// å»ºç«‹è¦é›¶å¾Œçš„è³‡æ–™å‰¯æœ¬
				const newData = { ...storageData.value };
				Object.keys(newData).forEach(sid => {
					newData[sid] = {
						...newData[sid],
						currentSpend: 0,
						lastUpdate: now.toISOString()
					};
				});

				try {
					// 3. åŒæ­¥åˆ°æœ¬åœ°
					storageData.value = newData;
					localStorage.setItem('cardMaster_v1.3', JSON.stringify(newData));

					// 4. åŒæ­¥åˆ°é›²ç«¯ (GAS)
					await fetch(config.value.gasUrl, {
						method: 'POST',
						mode: 'no-cors',
						body: JSON.stringify({ 
							...newData, 
							_sheetId: config.value.sheetId 
						})
					});

					// 5. æ›´æ–°æœˆä»½ç´€éŒ„ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
					localStorage.setItem('last_update_month', currentMonthKey);
					console.log("æ¯æœˆè‡ªå‹•è¦é›¶å®Œæˆ");
					// 5. æç¤ºå®Œæˆä¸¦è‡ªå‹•åˆ·æ–°é é¢
					if (typeof showToast === 'function') {
						showToast("æ¯æœˆè‡ªå‹•è¦é›¶å®Œæˆ", "success");
					}
				} catch (e) {
					console.log("è‡ªå‹•è¦é›¶åŒæ­¥å¤±æ•—:", e);
				}
			} else if (!lastMonthKey) {
				// ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œåƒ…è¨˜éŒ„ç•¶å‰æœˆä»½
				localStorage.setItem('last_update_month', currentMonthKey);
			}
			syncFromCloud();
		};

		// åœ¨åˆå§‹åŒ–è³‡æ–™è¼‰å…¥å¾ŒåŸ·è¡Œæ­¤æª¢æŸ¥
		// å¦‚æœä½ æœ‰ä¸€å€‹è¼‰å…¥ GAS è³‡æ–™çš„å‡½æ•¸ï¼Œè«‹åœ¨é‚£ä¹‹å¾Œå‘¼å«å®ƒ
		onMounted(() => {
			// å»¶é²ä¸€é»é»åŸ·è¡Œï¼Œç¢ºä¿ config èˆ‡ storageData å·²å°±ç·’
			setTimeout(checkAndResetMonthly, 1000); 
		});

        // --- è¨ˆç®—å±¬æ€§ ---
        const sortedResults = computed(() => {
		const sk = skInput.value.trim().toUpperCase();
		const matchedShop = shopDatabase.find(d => sk !== '' && d.name.toUpperCase().includes(sk));
		const cat = matchedShop ? matchedShop.category : 'ä¸€èˆ¬';

		// å»ºç«‹ä¸€å€‹å®‰å…¨æŠ“å–é‡‘é¡çš„è¼”åŠ©è®Šæ•¸
		const getSafeSpend = (id) => {
			return (storageData.value && storageData.value[id]) ? Number(storageData.value[id].currentSpend) : 0;
		};

		const list = [
			{ 
				id: 1, 
				...getRichart(cat, sk), 
				icon: 'fas fa-gem', iconColor: 'bg-rose-500', rounding: 'floor' 
			},
			{ 
				id: 2, 
				...getCTBC_UNI(cat, sk, uniCount.value, getSafeSpend('ctbc_uni')), 
				icon: 'fas fa-shopping-cart', iconColor: 'bg-orange-500', rounding: 'round' 
			},
			{ 
				id: 3, 
				...getCube(cat, sk, getSafeSpend('cathay_youth')), 
				icon: 'fas fa-id-card', iconColor: 'bg-emerald-600', rounding: 'round' 
			},
			{ 
				id: 4, 
				...getFed(cat, sk, getSafeSpend('fed_lb')), 
				icon: 'fas fa-comment-dollar', iconColor: 'bg-sky-500', rounding: 'round' 
			},
			{ 
				id: 5, 
				...getLINEPay(cat, sk, getSafeSpend('ctbc_lp')), 
				icon: 'fab fa-line', iconColor: 'bg-green-500', rounding: 'round' 
			}
		];
		return list.sort((a, b) => b.rate - a.rate);
	});

        const suggestions = computed(() => {
            if (!skInput.value) return [];
            const input = skInput.value.toUpperCase();
            return shopDatabase.filter(d => d.name.toUpperCase().includes(input)).slice(0, 6);
        });

        

        return {
            config, storageData, skInput, amount, uniCount, isSyncing, showSettings, showSuggestions, toast, detailCard, updateCard, tempAmount,
            calculateReward: (amt, rate, rounding) => {
                const val = amt * (rate / 100);
                return rounding === 'floor' ? Math.floor(val) : Math.round(val);
            },
            getCardStorage: (id) => storageData.value[id] || { currentSpend: 0 },
            getProgress: (res) => {
                if (!res.limitAmt) return 0;
                const spend = storageData.value[res.storeId]?.currentSpend || 0;
                return Math.min(Math.round((spend / res.limitAmt) * 100), 100);
            },
            syncFromCloud, openDetails: (c) => detailCard.value = c,
            openUpdate: (c) => { updateCard.value = c; tempAmount.value = amount.value; },
            confirmUpdate, resetCard, saveSettings, selectsk: (s) => { skInput.value = s.name; showSuggestions.value = false; },
            suggestions, sortedResults
        };
    }
}).mount('#app');
</script>
</body>
</html>